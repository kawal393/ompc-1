<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>APEX ‚Äî OMPC / ATA</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#05060a;
      --panel: rgba(12,14,20,.72);
      --panel2: rgba(12,14,20,.55);
      --stroke: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --gold: #d2b25d;
      --gold2:#b89642;
      --shadow: 0 14px 44px rgba(0,0,0,.55);
      --r: 18px;
      --r2: 14px;
      --max: 1080px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); }
    a{ color:inherit; }
    button{ font-family:inherit; }

    /* Background: particles + glow */
    #bg {
      position: fixed; inset: 0;
      width:100%; height:100%;
      z-index: 0;
      background: radial-gradient(1200px 700px at 50% 25%, rgba(210,178,93,.10), transparent 65%),
                  radial-gradient(900px 520px at 50% 62%, rgba(120,170,255,.05), transparent 62%),
                  radial-gradient(900px 520px at 20% 88%, rgba(210,178,93,.06), transparent 62%),
                  linear-gradient(180deg, #05060a, #04050a 58%, #02030a);
    }
    #noise {
      position: fixed; inset:0; z-index:1;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.32'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.22;
    }
    #sigilWrap{
      position: fixed; inset:0; z-index:1;
      pointer-events:none;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 3.2vh;
      opacity:.24;
      filter: drop-shadow(0 28px 90px rgba(0,0,0,.85));
    }
    #sigil{
      width:min(720px, 92vw);
      max-height: 62vh;
      object-fit: contain;
      transform: translateY(10px);
      opacity:.75;
    }

    /* App shell */
    .app { position: relative; z-index: 2; min-height: 100%; padding: 16px 14px 40px; }
    .wrap { max-width: var(--max); margin: 0 auto; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 10px 10px 6px;
      margin: 0 auto 10px;
      max-width: var(--max);
      color: var(--muted);
      font-size: 12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width: 0;
    }
    .brand img{
      width:22px; height:22px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 6px 22px rgba(0,0,0,.4);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(10,12,18,.55);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      white-space: nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: #2bd96b;
      box-shadow: 0 0 18px rgba(43,217,107,.65);
    }
    .btnRow{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      flex-wrap: wrap;
    }
    .btn{
      cursor:pointer;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(210,178,93,.32);
      background: linear-gradient(180deg, rgba(210,178,93,.10), rgba(0,0,0,.0));
      color: rgba(255,255,255,.9);
      font-weight: 650;
      letter-spacing: .2px;
      font-size: 12px;
      box-shadow: 0 12px 36px rgba(0,0,0,.35);
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(210,178,93,.52); }
    .btn:active{ transform: translateY(0px); }
    .btn.secondary{
      border-color: rgba(255,255,255,.12);
      background: rgba(10,12,18,.52);
      font-weight: 600;
    }

    .panel{
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .hero{
      padding: 18px;
      margin-top: 8px;
    }
    h1{
      margin: 0 0 8px;
      line-height: 1.05;
      font-size: 34px;
      letter-spacing: -0.6px;
    }
    .sub{
      margin:0 0 14px;
      color: var(--muted);
      font-size: 13px;
      max-width: 72ch;
    }
    .heroActions{ display:flex; gap:10px; flex-wrap: wrap; }

    .grid2{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
      h1{ font-size: 28px; }
    }

    .mini{
      padding: 12px 14px;
      background: var(--panel2);
      border-radius: var(--r2);
      border: 1px solid var(--stroke);
    }
    .miniTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 10px;
      color: rgba(255,255,255,.82);
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .7px;
    }
    .kv{
      display:flex; flex-wrap: wrap; gap: 8px 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .kv span{
      padding: 7px 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      white-space: nowrap;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap: wrap;
      margin-top: 12px;
    }
    .tab{
      cursor:pointer;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color: rgba(255,255,255,.82);
      font-weight: 650;
      font-size: 12px;
    }
    .tab.active{
      border-color: rgba(210,178,93,.45);
      background: rgba(210,178,93,.10);
    }

    .searchRow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin: 14px 0 10px;
      flex-wrap: wrap;
    }
    .search{
      flex: 1;
      min-width: 220px;
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.75);
    }
    .search input{
      flex:1; border:0; outline:0; background: transparent;
      color: rgba(255,255,255,.92);
      font-size: 13px;
    }
    .rightMeta{
      display:flex; align-items:center; gap:10px;
      color: var(--muted);
      font-size: 12px;
    }
    select{
      border-radius: 999px;
      padding: 9px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.86);
      outline: none;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      padding-bottom: 34vh; /* keep clear of sigil */
    }
    @media (max-width: 860px){
      .cards{ grid-template-columns: 1fr; }
    }
    .card{
      padding: 14px;
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      box-shadow: 0 16px 46px rgba(0,0,0,.35);
    }
    .cardTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .id{
      font-family: var(--mono);
      color: rgba(210,178,93,.82);
      font-size: 11px;
      letter-spacing: .3px;
    }
    .name{
      margin: 6px 0 2px;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: -.2px;
    }
    .sum{
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }
    .tagRow{ display:flex; gap:8px; flex-wrap: wrap; margin-bottom: 10px; }
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size: 11px;
      color: rgba(255,255,255,.78);
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(210,178,93,.40);
      background: rgba(210,178,93,.10);
      color: rgba(255,255,255,.85);
      font-size: 11px;
      white-space: nowrap;
    }
    .cardBtns{
      display:flex; gap:8px; flex-wrap: wrap;
    }
    .tiny{
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
      color: rgba(255,255,255,.86);
      font-weight: 700;
      font-size: 11px;
    }
    .tiny.primary{
      border-color: rgba(210,178,93,.45);
      background: rgba(210,178,93,.10);
    }

    /* Modal viewer */
    .modal{
      position: fixed; inset: 0;
      display:none;
      align-items: stretch;
      justify-content:center;
      z-index: 50;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 14px;
    }
    .modal.show{ display:flex; }
    .modalBox{
      width: min(980px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(8,10,16,.92);
      box-shadow: 0 30px 110px rgba(0,0,0,.72);
      overflow:hidden;
      display:flex;
      flex-direction: column;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .modalTitle{
      min-width:0;
      display:flex; flex-direction: column;
      gap: 2px;
    }
    .modalTitle strong{ font-size: 13px; }
    .modalTitle span{ color: var(--muted); font-size: 11px; font-family: var(--mono); }
    .modalBody{
      padding: 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      color: rgba(255,255,255,.92);
    }
    .modalBody pre{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      overflow:auto;
    }
    .md h1,.md h2,.md h3{ margin-top: 18px; }
    .md a{ color: rgba(210,178,93,.95); }
    .md blockquote{
      margin: 12px 0;
      padding: 10px 12px;
      border-left: 3px solid rgba(210,178,93,.55);
      background: rgba(210,178,93,.08);
      border-radius: 12px;
      color: rgba(255,255,255,.86);
    }

    /* Footer line */
    .foot{
      color: rgba(255,255,255,.42);
      font-size: 11px;
      text-align:center;
      margin-top: 14px;
      padding-bottom: 10px;
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <div id="noise"></div>

  <!-- faint sigil watermark -->
  <div id="sigilWrap" aria-hidden="true">
    <img id="sigil" src="apex-sigil.png" alt="">
  </div>

  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="apex-sigil.png" alt="APEX">
        <div class="pill">APEX ‚Äî OMPC / ATA <span style="opacity:.55;">|</span> Authority Registry ¬∑ Claims vs Reality ¬∑ Market Lens</div>
      </div>
      <div class="btnRow">
        <div class="pill"><span class="dot"></span><span id="liveText">LIVE SURFACE</span></div>
        <button class="btn secondary" id="repoBtn">REPO</button>
        <button class="btn" id="copyCitationTop">COPY CITATION PATTERN</button>
      </div>
    </div>

    <div class="wrap">
      <div class="panel hero">
        <h1>Authority you can cite.<br/>Evidence you can anchor.</h1>
        <p class="sub">
          Public registry of records (ATA/OMPC style) plus a second layer that converts records into structured intelligence:
          mismatch signals, catalysts, timelines, watchlists. Clean. Calm. Weapon-grade.
        </p>

        <div class="heroActions">
          <button class="btn" data-route="#/ledger">ENTER LEDGER</button>
          <button class="btn secondary" data-route="#/lens">OPEN MARKET LENS</button>
          <button class="btn secondary" id="forceRefresh">FORCE REFRESH</button>
        </div>

        <div class="grid2">
          <div class="mini">
            <div class="miniTitle">
              <span>LIVE SURFACE</span>
              <span class="badge" id="registryBadge">Registry: ‚Äî</span>
            </div>
            <div class="kv" id="kvLeft">
              <span id="kvEntries">Entries: ‚Äî</span>
              <span id="kvViewer">Viewer: ‚Äî</span>
              <span id="kvTz">Timezone: ‚Äî</span>
              <span id="kvLocale">Locale: ‚Äî</span>
              <span id="kvNow">Now: ‚Äî</span>
            </div>

            <div class="tabs" style="margin-top:12px;">
              <button class="tab active" data-route="#/ledger">LEDGER</button>
              <button class="tab" data-route="#/lens">MARKET LENS</button>
              <button class="tab" data-route="#/pricing">PRICING</button>
              <button class="tab" data-route="#/contact">CONTACT</button>
            </div>
          </div>

          <div class="mini">
            <div class="miniTitle">
              <span>MARKET LENS (PAID LAYER)</span>
              <span class="badge">Mismatch Watch</span>
            </div>
            <div class="sub" style="margin:0;">
              Ledger stays public; lens becomes the product. We surface contradictions + catalysts + timelines
              without exposing internal mechanics.
            </div>
            <div class="kv" style="margin-top:10px;">
              <span>Lens: <b style="color:rgba(255,255,255,.85)">Active</b></span>
              <span>Output: <b style="color:rgba(255,255,255,.85)">Watchlists</b></span>
              <span>Mode: <b style="color:rgba(255,255,255,.85)">Surface</b></span>
            </div>
          </div>
        </div>
      </div>

      <div id="page">
        <!-- dynamic -->
      </div>

      <div class="foot">¬© 2026 APEX ‚Äî OMPC / ATA Surface ‚Ä¢ Data: <span id="dataPath">registry/index.json</span></div>
    </div>
  </div>

  <!-- Modal viewer -->
  <div class="modal" id="modal">
    <div class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">
          <strong id="modalName">Entry</strong>
          <span id="modalPath">‚Äî</span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="tiny" id="modalCopyCitation">COPY CITATION</button>
          <button class="tiny" id="modalOpenSource">SOURCE</button>
          <button class="tiny primary" id="modalClose">CLOSE</button>
        </div>
      </div>
      <div class="modalBody">
        <div id="modalContent" class="md">Loading‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Markdown renderer (small + reliable) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // ---------- Config ----------
    const REGISTRY_URL = "registry/index.json"; // this is what your UI should trust
    const VIEWER_CITY = "Sydney";
    const TIMEZONE = "Australia/Sydney";
    const LOCALE = "en-AU";

    // For "SOURCE" links: open raw markdown on this Pages site.
    // Example: https://kawal393.github.io/ompc-1/entries/ATA-....md
    function siteBase(){
      // Handles /ompc-1/ base path automatically
      const p = location.pathname;
      // If you're on /ompc-1/..., base is "/ompc-1/"
      const parts = p.split("/").filter(Boolean);
      if (parts.length > 0) return "/" + parts[0] + "/";
      return "/";
    }

    // ---------- State ----------
    let state = {
      registry: null,
      entries: [],
      filter: "",
      status: "all",
      lastOpened: null
    };

    // ---------- Utility ----------
    function $(id){ return document.getElementById(id); }
    function escapeHtml(s){
      return (s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function nowString(){
      try{
        return new Intl.DateTimeFormat(LOCALE, { dateStyle:"full", timeStyle:"medium", timeZone: TIMEZONE }).format(new Date());
      }catch{
        return new Date().toLocaleString();
      }
    }
    function setActiveTab(route){
      document.querySelectorAll(".tab").forEach(t => {
        t.classList.toggle("active", t.getAttribute("data-route") === route);
      });
    }

    // ---------- Citation ----------
    function citationPattern(id, name){
      const date = state.registry?.updated || new Date().toISOString().slice(0,10);
      return `APEX-OMPC/ATA ‚Äî ${id} (${name}) ‚Äî Registry snapshot ${date} ‚Äî ${location.origin}${siteBase()}#${encodeURIComponent("/entry/"+id)}`;
    }
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
    }

    // ---------- Data ----------
    async function loadRegistry(){
      const url = REGISTRY_URL + "?v=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("Registry fetch failed: " + res.status);
      const json = await res.json();
      state.registry = json;
      state.entries = (json.entries || []).map(e => ({
        id: e.id || "",
        name: e.name || "",
        summary: e.summary || "",
        status: (e.status || "unverified").toLowerCase(),
        entry_path: e.entry_path || "",
        tags: Array.isArray(e.tags) ? e.tags : []
      }));
      $("dataPath").textContent = REGISTRY_URL;
      $("registryBadge").textContent = "Registry: Live (" + REGISTRY_URL + ")";
      $("kvEntries").textContent = "Entries: " + state.entries.length;
      $("kvViewer").textContent = "Viewer: " + VIEWER_CITY;
      $("kvTz").textContent = "Timezone: " + TIMEZONE;
      $("kvLocale").textContent = "Locale: " + LOCALE;
      $("kvNow").textContent = "Now: " + nowString();
    }

    // ---------- Pages ----------
    function renderLedger(){
      const page = $("page");
      page.innerHTML = `
        <div class="panel" style="margin-top:12px; padding:14px;">
          <div class="searchRow">
            <div class="search">
              <span style="opacity:.7">üîé</span>
              <input id="q" placeholder="Search: company, tags, ID, jurisdiction‚Ä¶" />
            </div>
            <div class="rightMeta">
              <select id="status">
                <option value="all">Status: All</option>
                <option value="unverified">Status: Unverified</option>
                <option value="verified">Status: Verified</option>
              </select>
              <span id="metaRight">Entries: ${state.entries.length} ‚Ä¢ Updated: ${escapeHtml(state.registry?.updated || "‚Äî")}</span>
            </div>
          </div>
          <div class="cards" id="cards"></div>
        </div>
      `;

      const q = page.querySelector("#q");
      const st = page.querySelector("#status");
      q.value = state.filter || "";
      st.value = state.status || "all";
      q.addEventListener("input", () => { state.filter = q.value; drawCards(); });
      st.addEventListener("change", () => { state.status = st.value; drawCards(); });

      drawCards();
    }

    function drawCards(){
      const el = $("cards");
      if(!el) return;

      const term = (state.filter || "").trim().toLowerCase();
      const want = (state.status || "all").toLowerCase();

      const list = state.entries.filter(e => {
        if(want !== "all" && e.status !== want) return false;
        if(!term) return true;
        const blob = [e.id, e.name, e.summary, (e.tags||[]).join(" ")].join(" ").toLowerCase();
        return blob.includes(term);
      });

      el.innerHTML = list.map(e => `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="id">${escapeHtml(e.id)}</div>
              <div class="name">${escapeHtml(e.name)}</div>
              <div class="sum">${escapeHtml(e.summary)}</div>
            </div>
            <div class="badge">${escapeHtml(e.status)}</div>
          </div>
          <div class="tagRow">
            ${(e.tags||[]).slice(0,6).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
          </div>
          <div class="cardBtns">
            <button class="tiny primary" data-open="${escapeHtml(e.id)}">OPEN</button>
            <button class="tiny" data-cite="${escapeHtml(e.id)}">COPY CITATION</button>
            <button class="tiny" data-source="${escapeHtml(e.id)}">SOURCE</button>
          </div>
        </div>
      `).join("");

      el.querySelectorAll("[data-open]").forEach(b => b.addEventListener("click", () => openEntry(b.getAttribute("data-open"))));
      el.querySelectorAll("[data-cite]").forEach(b => b.addEventListener("click", () => {
        const id = b.getAttribute("data-cite");
        const e = state.entries.find(x => x.id === id);
        copyText(citationPattern(e.id, e.name));
      }));
      el.querySelectorAll("[data-source]").forEach(b => b.addEventListener("click", () => {
        const id = b.getAttribute("data-source");
        const e = state.entries.find(x => x.id === id);
        if(!e) return;
        const url = location.origin + siteBase() + e.entry_path;
        window.open(url, "_blank", "noopener");
      }));
    }

    function renderLens(){
      $("page").innerHTML = `
        <div class="panel" style="margin-top:12px; padding:16px;">
          <div class="miniTitle"><span>MARKET LENS</span><span class="badge">Paid Layer</span></div>
          <p class="sub" style="margin:0;">
            This page is a clean placeholder so buttons don‚Äôt dead-end.
            When you‚Äôre ready, we‚Äôll wire ‚ÄúMismatch Watch‚Äù outputs (watchlists, catalysts, contradictions) without exposing internal mechanics.
          </p>
          <div class="kv" style="margin-top:12px;">
            <span>Mode: <b style="color:rgba(255,255,255,.85)">Surface</b></span>
            <span>Output: <b style="color:rgba(255,255,255,.85)">Watchlists</b></span>
            <span>Status: <b style="color:rgba(255,255,255,.85)">Active</b></span>
          </div>
        </div>
      `;
    }

    function renderPricing(){
      $("page").innerHTML = `
        <div class="panel" style="margin-top:12px; padding:16px;">
          <div class="miniTitle"><span>PRICING</span><span class="badge">Draft</span></div>
          <div class="sub" style="margin:0;">
            <b>Surface (Public):</b> Free registry access.<br/>
            <b>Lens (Pro):</b> Watchlists + mismatch signals + catalyst summaries.<br/>
            <b>Enterprise:</b> Custom monitoring + private feeds.
          </div>
          <div class="kv" style="margin-top:12px;">
            <span>Pro: Monthly</span>
            <span>Enterprise: Annual</span>
            <span>Contact to provision</span>
          </div>
        </div>
      `;
    }

    function renderContact(){
      $("page").innerHTML = `
        <div class="panel" style="margin-top:12px; padding:16px;">
          <div class="miniTitle"><span>CONTACT</span><span class="badge">Secure</span></div>
          <p class="sub" style="margin:0;">
            Add your contact method inside this panel when ready (email, form, or link).
            For now, the point is: clients never see broken buttons.
          </p>
        </div>
      `;
    }

    // ---------- Entry Viewer ----------
    async function openEntry(id){
      const e = state.entries.find(x => x.id === id);
      if(!e) return;
      state.lastOpened = e;

      $("modalName").textContent = e.name || e.id;
      $("modalPath").textContent = e.entry_path || "(missing entry_path)";
      $("modalContent").textContent = "Loading‚Ä¶";
      $("modal").classList.add("show");

      $("modalCopyCitation").onclick = () => copyText(citationPattern(e.id, e.name));
      $("modalOpenSource").onclick = () => {
        const url = location.origin + siteBase() + e.entry_path;
        window.open(url, "_blank", "noopener");
      };

      try{
        const url = e.entry_path + "?v=" + Date.now();
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("Entry fetch failed: " + res.status);
        const md = await res.text();
        const html = marked.parse(md, { mangle:false, headerIds:false });
        $("modalContent").innerHTML = html;
      }catch(err){
        $("modalContent").innerHTML = `<pre>${escapeHtml(String(err))}</pre>`;
      }
    }

    function closeModal(){
      $("modal").classList.remove("show");
    }

    // ---------- Router ----------
    function route(){
      const hash = location.hash || "#/ledger";
      const routeKey = hash.split("?")[0];

      setActiveTab(routeKey);

      if(routeKey === "#/lens") renderLens();
      else if(routeKey === "#/pricing") renderPricing();
      else if(routeKey === "#/contact") renderContact();
      else renderLedger();
    }

    // ---------- Particles ----------
    function startParticles(){
      const c = $("bg");
      const ctx = c.getContext("2d", { alpha: true });

      let w=0,h=0, dpr=1;
      let particles = [];
      const N = 70; // tuned for mobile

      function resize(){
        dpr = Math.min(2, window.devicePixelRatio || 1);
        w = Math.floor(window.innerWidth);
        h = Math.floor(window.innerHeight);
        c.width = Math.floor(w*dpr);
        c.height= Math.floor(h*dpr);
        c.style.width = w+"px";
        c.style.height= h+"px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }

      function rand(min,max){ return min + Math.random()*(max-min); }
      function make(){
        particles = Array.from({length:N}, () => ({
          x: rand(0,w),
          y: rand(0,h),
          r: rand(0.9, 2.4),
          vx: rand(-0.18, 0.18),
          vy: rand(-0.14, 0.14),
          a: rand(0.22, 0.72),
          hue: Math.random() < 0.7 ? "gold" : "cool"
        }));
      }

      function tick(){
        ctx.clearRect(0,0,w,h);

        // subtle vignette
        const g = ctx.createRadialGradient(w*0.5, h*0.35, 0, w*0.5, h*0.5, Math.max(w,h)*0.75);
        g.addColorStop(0, "rgba(210,178,93,0.05)");
        g.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = g;
        ctx.fillRect(0,0,w,h);

        // update + draw
        for(const p of particles){
          p.x += p.vx;
          p.y += p.vy;

          // wrap
          if(p.x < -20) p.x = w+20;
          if(p.x > w+20) p.x = -20;
          if(p.y < -20) p.y = h+20;
          if(p.y > h+20) p.y = -20;

          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);

          if(p.hue === "gold") ctx.fillStyle = `rgba(210,178,93,${p.a})`;
          else ctx.fillStyle = `rgba(140,190,255,${p.a*0.55})`;

          ctx.fill();
        }

        // connections (nearby)
        for(let i=0;i<particles.length;i++){
          for(let j=i+1;j<particles.length;j++){
            const a = particles[i], b = particles[j];
            const dx=a.x-b.x, dy=a.y-b.y;
            const dist = Math.hypot(dx,dy);
            if(dist < 140){
              const alpha = (1 - dist/140) * 0.18;
              ctx.strokeStyle = `rgba(210,178,93,${alpha})`;
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(a.x,a.y);
              ctx.lineTo(b.x,b.y);
              ctx.stroke();
            }
          }
        }

        requestAnimationFrame(tick);
      }

      resize(); make(); tick();
      window.addEventListener("resize", () => { resize(); make(); });
    }

    // ---------- Boot ----------
    (async function init(){
      // buttons
      document.querySelectorAll("[data-route]").forEach(b => b.addEventListener("click", () => {
        location.hash = b.getAttribute("data-route");
      }));
      $("modalClose").addEventListener("click", closeModal);
      $("modal").addEventListener("click", (e) => { if(e.target === $("modal")) closeModal(); });

      $("copyCitationTop").addEventListener("click", () => copyText("APEX-OMPC/ATA ‚Äî [ENTRY-ID] ([ENTITY]) ‚Äî Registry snapshot [YYYY-MM-DD] ‚Äî [URL]"));
      $("forceRefresh").addEventListener("click", async () => {
        await loadRegistry();
        route();
      });

      $("repoBtn").addEventListener("click", () => {
        // Best-effort: open the repo relative link if you're on GitHub Pages
        // If this doesn't resolve, it still doesn't break anything.
        const guess = "https://github.com/" + (location.hostname.includes("github.io") ? location.hostname.split(".")[0] : "") + "/";
        window.open(guess, "_blank", "noopener");
      });

      // load data
      try{
        await loadRegistry();
      }catch(err){
        $("page").innerHTML = `<div class="panel" style="margin-top:12px; padding:14px;">
          <div class="miniTitle"><span>DATA ERROR</span><span class="badge">Registry</span></div>
          <pre>${escapeHtml(String(err))}</pre>
          <div class="sub">Check that <b>${escapeHtml(REGISTRY_URL)}</b> exists and is valid JSON.</div>
        </div>`;
      }

      // router
      window.addEventListener("hashchange", route);
      route();

      // particles
      startParticles();

      // update clock
      setInterval(() => { $("kvNow").textContent = "Now: " + nowString(); }, 1000);
    })();
  </script>
</body>
</html>
