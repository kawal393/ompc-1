<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APEX — OMPC / ATA Surface</title>
  <meta name="description" content="Authority registry + market lens. Evidence anchored. Claims vs reality." />
  <style>
    :root{
      --bg0:#050607;
      --bg1:#0a0c10;
      --panel: rgba(18,20,24,.62);
      --panel2: rgba(18,20,24,.78);
      --stroke: rgba(255,255,255,.08);
      --stroke2: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.42);
      --gold: #d7b56d;
      --gold2: #b89455;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 14px 50px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 26px;
      --max: 1040px;
      --blur: 14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: radial-gradient(1200px 800px at 18% 18%, rgba(215,181,109,.10), transparent 60%),
                  radial-gradient(900px 600px at 86% 22%, rgba(215,181,109,.08), transparent 65%),
                  radial-gradient(900px 900px at 50% 90%, rgba(120,140,255,.05), transparent 65%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* moving particles canvas */
    #fx{
      position:fixed; inset:0;
      z-index:0;
      opacity:.85;
      pointer-events:none;
    }

    /* subtle geometric lines overlay */
    .grid{
      position:fixed; inset:0;
      background:
        linear-gradient(to right, rgba(255,255,255,.04) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.035) 1px, transparent 1px);
      background-size: 96px 96px;
      mask-image: radial-gradient(closest-side at 50% 20%, rgba(0,0,0,.85), transparent 70%);
      opacity:.20;
      z-index:1;
      pointer-events:none;
    }

    /* BIG watermark */
    .watermark{
      position:fixed; inset:0;
      z-index:1;
      pointer-events:none;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 6vh;
    }
    .watermark img{
      width:min(92vw, 860px);
      opacity:.16;              /* stronger */
      filter: saturate(1.1) contrast(1.05) drop-shadow(0 18px 50px rgba(0,0,0,.75));
      mix-blend-mode: screen;   /* makes it glow against dark */
      transform: translateY(10px);
    }

    /* content */
    .wrap{
      position:relative;
      z-index:2;
      max-width: var(--max);
      margin: 18px auto 64px;
      padding: 0 14px;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(var(--blur));
      border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }

    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand .sigil{
      width:34px; height:34px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand .sigil img{width:100%; height:100%; object-fit:cover; opacity:.95}
    .brand .txt{min-width:0}
    .brand .title{
      font-weight: 740;
      letter-spacing:.4px;
      font-size: 13px;
      line-height: 1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand .sub{
      font-size: 11px;
      color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .status{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
      font-size: 11px; color: var(--muted);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.28);
    }
    .dot{width:8px; height:8px; border-radius:99px; background: var(--good); box-shadow:0 0 18px rgba(52,211,153,.35)}
    .btn{
      cursor:pointer;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.34);
      color: var(--text);
      padding:9px 12px;
      border-radius: 12px;
      font-weight: 650;
      font-size: 12px;
      letter-spacing:.25px;
      transition: .15s ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(215,181,109,.45); box-shadow: 0 10px 34px rgba(0,0,0,.35)}
    .btn.gold{
      border-color: rgba(215,181,109,.42);
      background: linear-gradient(180deg, rgba(215,181,109,.18), rgba(0,0,0,.28));
    }

    .hero{
      margin-top: 14px;
      border-radius: var(--radius2);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,.36), rgba(0,0,0,.22));
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
    }
    .hero h1{
      margin: 4px 0 4px;
      font-size: 34px;
      line-height: 1.03;
      letter-spacing: -0.6px;
    }
    .hero p{
      margin: 8px 0 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 68ch;
    }

    .hero-actions{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 8px}
    .meta-row{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 860px){
      .meta-row{grid-template-columns: 1fr}
      .hero h1{font-size: 30px}
    }
    .meta{
      padding: 12px 12px;
      border:1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(0,0,0,.26);
      min-height: 64px;
    }
    .meta .k{font-size: 11px; color: var(--muted2); letter-spacing:.3px; text-transform:uppercase}
    .meta .v{margin-top:6px; font-weight:740}
    .meta .tag{color: rgba(215,181,109,.92)}
    .meta .right{float:right; color: var(--muted2); font-weight:650}

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 14px 0 8px;
    }
    .tab{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.28);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 760;
      font-size: 12px;
      letter-spacing:.25px;
      cursor:pointer;
    }
    .tab.active{
      border-color: rgba(215,181,109,.48);
      background: linear-gradient(180deg, rgba(215,181,109,.16), rgba(0,0,0,.26));
    }

    .panel{
      margin-top: 10px;
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background: var(--panel);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding: 12px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      background: rgba(0,0,0,.22);
    }
    .panel-head .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .panel-head input, .panel-head select{
      background: rgba(0,0,0,.26);
      border:1px solid var(--stroke);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      outline:none;
      font-weight:650;
      font-size: 12px;
    }
    .panel-body{padding: 12px}
    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){ .cards{grid-template-columns: 1fr} }

    .card{
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(0,0,0,.26);
      padding: 12px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(500px 140px at 20% 0%, rgba(215,181,109,.13), transparent 55%);
      opacity:.85;
      pointer-events:none;
    }
    .card .row{position:relative; display:flex; gap:10px; align-items:flex-start; justify-content:space-between}
    .id{
      font-weight:800; letter-spacing:.4px;
      color: rgba(215,181,109,.95);
      font-size: 12px;
    }
    .name{margin-top: 6px; font-size: 18px; font-weight: 820; letter-spacing:-.2px}
    .small{margin-top: 6px; color: var(--muted); font-size: 12px; line-height: 1.35}
    .chips{margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; position:relative}
    .chip{
      font-size: 11px; font-weight: 720;
      padding:6px 10px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(0,0,0,.24);
      color: rgba(255,255,255,.78);
    }
    .chip.status{border-color: rgba(255,255,255,.10)}
    .chip.unverified{border-color: rgba(251,191,36,.35); color: rgba(251,191,36,.95)}
    .chip.verified{border-color: rgba(52,211,153,.35); color: rgba(52,211,153,.95)}
    .actions{margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; position:relative}

    .footer{
      margin-top: 14px;
      color: var(--muted2);
      font-size: 11px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding: 6px 2px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    a{color: rgba(215,181,109,.95)}
  </style>
</head>

<body>
  <canvas id="fx"></canvas>
  <div class="grid"></div>
  <div class="watermark">
    <img src="./apex-sigil.png" alt="APEX watermark" />
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="sigil"><img src="./apex-sigil.png" alt="APEX"/></div>
        <div class="txt">
          <div class="title">APEX — OMPC / ATA</div>
          <div class="sub">Authority Registry • Claims vs Reality • Market Lens</div>
        </div>
      </div>
      <div class="status">
        <span class="pill"><span class="dot"></span><b>LIVE SURFACE</b></span>
        <span class="pill" id="stamp">READY • —</span>
        <a class="btn" id="btnRepo" href="#" target="_blank" rel="noreferrer">REPO</a>
        <button class="btn gold" id="btnCopy">COPY CITATION PATTERN</button>
      </div>
    </div>

    <div class="hero">
      <div class="pill" style="display:inline-flex; gap:10px; margin-bottom:10px;">
        <span style="color:rgba(215,181,109,.95); font-weight:800;">LIVE SURFACE</span>
        <span style="color:var(--muted2)">READY</span>
        <span style="color:var(--muted2)">•</span>
        <span id="clock" style="color:var(--muted)">—</span>
      </div>

      <h1>Authority you can cite.<br/>Evidence you can anchor.</h1>
      <p>
        This surface exposes a public registry of records (ATA/OMPC style) and a second layer that turns those records into structured intelligence:
        contradictions, catalysts, and watchlists. Same APEX tone. Clean. Calm. Weapon-grade.
      </p>

      <div class="hero-actions">
        <button class="btn gold" id="btnLedger">ENTER LEDGER</button>
        <button class="btn" id="btnLens">OPEN MARKET LENS</button>
        <button class="btn" id="btnPattern">COPY CITATION PATTERN</button>
      </div>

      <div class="meta-row">
        <div class="meta">
          <div class="k">Registry</div>
          <div class="v"><span id="regState" class="tag">Loading…</span> <span class="right" id="regPath">—</span></div>
        </div>
        <div class="meta">
          <div class="k">Entries</div>
          <div class="v"><span id="count" class="tag">—</span> <span class="right mono">JSON</span></div>
        </div>
        <div class="meta">
          <div class="k">Lens</div>
          <div class="v"><span class="tag">Mismatch Watch</span> <span class="right mono">APEX</span></div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="ledger">LEDGER</button>
        <button class="tab" data-tab="lens">MARKET LENS</button>
        <button class="tab" data-tab="pricing">PRICING</button>
        <button class="tab" data-tab="contact">CONTACT</button>
      </div>
    </div>

    <div class="panel" id="panelLedger">
      <div class="panel-head">
        <div class="left">
          <input id="q" placeholder="Search: company, tags, ID, jurisdiction…" />
          <select id="status">
            <option value="all">Status: All</option>
            <option value="unverified">Unverified</option>
            <option value="verified">Verified</option>
          </select>
        </div>
        <div class="left">
          <span class="pill"><b class="mono" id="metaCount">Entries: —</b></span>
          <span class="pill"><span id="updated">Updated: —</span></span>
          <button class="btn" id="btnRefresh">FORCE REFRESH</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="cards" id="cards"></div>
      </div>
    </div>

    <div class="panel" id="panelLens" style="display:none;">
      <div class="panel-head">
        <div class="left">
          <b>Market Lens</b>
          <span class="pill" style="color:var(--muted)">Claims → Outcomes tracking</span>
        </div>
      </div>
      <div class="panel-body" style="color:var(--muted); line-height:1.55;">
        <b style="color:rgba(215,181,109,.95)">Two-tier business surface:</b>
        <ol>
          <li><b>Public Ledger</b> — open records, cite IDs, audit sources.</li>
          <li><b>Market Lens</b> — converts those records into structured watchlists and contradiction tracking (claims vs disclosures vs outcomes over time).</li>
        </ol>
        <div class="pill" style="margin-top:10px;">
          <span style="color:rgba(215,181,109,.95); font-weight:800;">Rule:</span>
          <span style="color:var(--muted)">Ledger is public. Lens becomes paid.</span>
        </div>
      </div>
    </div>

    <div class="panel" id="panelPricing" style="display:none;">
      <div class="panel-head">
        <div class="left"><b>Pricing</b><span class="pill" style="color:var(--muted)">Simple. Sharp. No fluff.</span></div>
      </div>
      <div class="panel-body">
        <div class="cards">
          <div class="card">
            <div class="id">PUBLIC</div>
            <div class="name">Ledger Access</div>
            <div class="small">Browse entries • cite IDs • verify sources</div>
            <div class="chips"><span class="chip">Free</span><span class="chip">Public</span></div>
          </div>
          <div class="card">
            <div class="id">PAID</div>
            <div class="name">Market Lens</div>
            <div class="small">Mismatch watchlists • catalysts • timelines • alerts</div>
            <div class="chips"><span class="chip">Subscription</span><span class="chip">Premium</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" id="panelContact" style="display:none;">
      <div class="panel-head">
        <div class="left"><b>Contact</b><span class="pill" style="color:var(--muted)">Wire a mandate. Request coverage.</span></div>
      </div>
      <div class="panel-body" style="color:var(--muted); line-height:1.55;">
        Put your contact method here (email / form link). Keep it minimal.
        <div class="pill" style="margin-top:10px;">
          <span class="mono">Citation pattern:</span>
          <span class="mono" style="color:rgba(215,181,109,.95); font-weight:800;">OMPC-1 • ATA-YYYY-NNNN</span>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>© <span id="year"></span> APEX • OMPC / ATA Surface</div>
      <div class="mono" id="paths">—</div>
    </div>
  </div>

<script>
/* =========================
   1) MOVING PARTICLES (NO LIBS)
   ========================= */
(function(){
  const c = document.getElementById('fx');
  const ctx = c.getContext('2d', { alpha:true });
  let w=0,h=0,dpr=1;
  let nodes=[];
  const N = 72; // tuned for mobile

  function resize(){
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    w = c.width = Math.floor(innerWidth * dpr);
    h = c.height = Math.floor(innerHeight * dpr);
    c.style.width = innerWidth+'px';
    c.style.height = innerHeight+'px';
    nodes = [];
    for(let i=0;i<N;i++){
      nodes.push({
        x: Math.random()*w,
        y: Math.random()*h,
        vx:(Math.random()-.5)*0.22*dpr,
        vy:(Math.random()-.5)*0.22*dpr,
        r: (Math.random()*1.6 + 0.6)*dpr,
        a: Math.random()*0.55 + 0.2
      });
    }
  }

  function step(){
    ctx.clearRect(0,0,w,h);

    // slight vignette
    const g = ctx.createRadialGradient(w*0.5,h*0.25, 0, w*0.5,h*0.25, Math.max(w,h)*0.75);
    g.addColorStop(0,'rgba(215,181,109,0.06)');
    g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    // links
    for(let i=0;i<nodes.length;i++){
      const a = nodes[i];
      a.x += a.vx; a.y += a.vy;
      if(a.x<0) a.x=w; if(a.x>w) a.x=0;
      if(a.y<0) a.y=h; if(a.y>h) a.y=0;

      for(let j=i+1;j<nodes.length;j++){
        const b = nodes[j];
        const dx=a.x-b.x, dy=a.y-b.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const max = 170*dpr;
        if(dist<max){
          const alpha = (1 - dist/max) * 0.18;
          ctx.strokeStyle = `rgba(215,181,109,${alpha})`;
          ctx.lineWidth = 1*dpr;
          ctx.beginPath();
          ctx.moveTo(a.x,a.y);
          ctx.lineTo(b.x,b.y);
          ctx.stroke();
        }
      }
    }

    // dots
    for(const p of nodes){
      ctx.fillStyle = `rgba(255,255,255,${p.a})`;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }

    requestAnimationFrame(step);
  }

  window.addEventListener('resize', resize, {passive:true});
  resize();
  step();
})();

/* =========================
   2) UI / TABS
   ========================= */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);

$('#year').textContent = new Date().getFullYear();
$('#clock').textContent = new Date().toISOString().slice(0,16).replace('T',' ');
$('#stamp').textContent = `READY • ${new Date().toISOString().slice(0,10)} ${new Date().toTimeString().slice(0,5)}`;

const tabs = $$('.tab');
const panels = {
  ledger: $('#panelLedger'),
  lens: $('#panelLens'),
  pricing: $('#panelPricing'),
  contact: $('#panelContact')
};
tabs.forEach(t=>{
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    Object.values(panels).forEach(p=>p.style.display='none');
    panels[t.dataset.tab].style.display='block';
    window.scrollTo({top:0, behavior:'smooth'});
  });
});
$('#btnLedger').onclick = ()=>tabs[0].click();
$('#btnLens').onclick = ()=>tabs[1].click();

function copyText(txt){
  navigator.clipboard?.writeText(txt).catch(()=>{});
}
const pattern = 'OMPC-1 • ATA-YYYY-NNNN • (entry path) • (commit link)';
$('#btnCopy').onclick = ()=>copyText(pattern);
$('#btnPattern').onclick = ()=>copyText(pattern);

/* =========================
   3) AUTO-INDEX ENTRIES (YOUR 15 FILES)
   Uses GitHub API to list /entries/*.md on Pages.
   ========================= */

const OWNER = location.hostname.split('.')[0]; // kawal393
const REPO  = location.pathname.split('/').filter(Boolean)[0] || 'ompc-1';

$('#btnRepo').href = `https://github.com/${OWNER}/${REPO}`;

const PATHS = {
  registry: './registry/index.json',
  entriesFolder: 'entries'
};
$('#regPath').textContent = '(auto-index)';
$('#paths').textContent = `/entries/*.md (auto-index) • optional /registry/index.json`;

let ALL = [];

function deriveNameFromFilename(fn){
  // ATA-2026-0014-NVIDIA.md -> NVIDIA
  const base = fn.replace(/\.md$/,'');
  const parts = base.split('-');
  // after the first 3-4 segments, the rest is name
  const idx = parts.findIndex(p=>p.toUpperCase()==='ATA')>=0 ? 0 : 0;
  // safer: strip leading "ATA-YYYY-NNNN-"
  const m = base.match(/^ATA-\d{4}-\d{4}-(.+)$/i);
  return m ? m[1].replace(/_/g,' ').trim() : base;
}

async function listEntryFiles(){
  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATHS.entriesFolder}`;
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error('Cannot list /entries. Check folder name & repo public.');
  const data = await r.json();
  return (data||[]).filter(x=>x.type==='file' && /\.md$/i.test(x.name));
}

async function tryLoadRegistryIndex(){
  // optional: if you *do* have registry/index.json, we use it
  try{
    const r = await fetch(PATHS.registry, { cache:'no-store' });
    if(!r.ok) throw new Error('no registry');
    const j = await r.json();
    if(j && Array.isArray(j.entries) && j.entries.length){
      $('#regState').textContent = 'Live (registry/index.json)';
      $('#regState').style.color = 'rgba(52,211,153,.95)';
      $('#regPath').textContent = PATHS.registry;
      $('#updated').textContent = 'Updated: ' + (j.updated || '—');
      return j.entries.map(e=>({
        id: e.id || '—',
        name: e.name || '—',
        type: e.type || '—',
        jurisdiction: e.jurisdiction || '—',
        scope: e.scope || '—',
        status: (e.status || 'unverified').toLowerCase(),
        tags: e.tags || [],
        summary: e.summary || '',
        source_url: e.source_url || '',
        entry_path: e.entry_path || ''
      }));
    }
  }catch(e){}
  return null;
}

function normalizeFromFiles(files){
  // build a minimal entry set from filenames; deep details stay inside markdown (OPEN loads it)
  return files.map(f=>{
    const idMatch = f.name.match(/ATA-\d{4}-\d{4}/i);
    const id = idMatch ? idMatch[0].toUpperCase() : f.name.replace(/\.md$/,'');
    const nm = deriveNameFromFilename(f.name);
    return {
      id,
      name: nm,
      type: 'Public Record',
      jurisdiction: '—',
      scope: '—',
      status: 'unverified',
      tags: [],
      summary: 'Public attestation record. Presence-only. Source-anchored.',
      source_url: '',
      entry_path: `./entries/${f.name}`
    };
  }).sort((a,b)=>a.id.localeCompare(b.id));
}

function render(list){
  const cards = $('#cards');
  cards.innerHTML = '';
  const q = ($('#q').value||'').trim().toLowerCase();
  const st = $('#status').value;

  const filtered = list.filter(e=>{
    if(st!=='all' && (e.status||'').toLowerCase()!==st) return false;
    if(!q) return true;
    const hay = [
      e.id, e.name, e.type, e.jurisdiction, e.scope,
      (e.tags||[]).join(' '),
      e.summary
    ].join(' ').toLowerCase();
    return hay.includes(q);
  });

  $('#metaCount').textContent = `Entries: ${filtered.length}`;
  $('#count').textContent = String(filtered.length);

  for(const e of filtered){
    const el = document.createElement('div');
    el.className = 'card';
    const statusClass = (e.status||'unverified')==='verified' ? 'verified' : 'unverified';
    el.innerHTML = `
      <div class="row">
        <div>
          <div class="id">${escapeHtml(e.id||'—')}</div>
          <div class="name">${escapeHtml(e.name||'—')}</div>
          <div class="small">${escapeHtml([e.type,e.jurisdiction,e.scope].filter(Boolean).join(' • '))}</div>
          <div class="small">${escapeHtml(e.summary||'')}</div>
        </div>
        <div class="chips" style="justify-content:flex-end;">
          <span class="chip status ${statusClass}">${escapeHtml((e.status||'unverified').replace(/^\w/,c=>c.toUpperCase()))}</span>
          ${(e.tags||[]).slice(0,4).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}
        </div>
      </div>
      <div class="actions">
        <button class="btn gold" data-open="${escapeAttr(e.entry_path||'')}">OPEN</button>
        <button class="btn" data-lens="${escapeAttr(e.id||'')}">LENS</button>
        <a class="btn" href="${escapeAttr(e.source_url||'#')}" target="_blank" rel="noreferrer">SOURCE</a>
        <button class="btn" data-cite="${escapeAttr(e.id||'')}">COPY CITATION</button>
      </div>
    `;
    cards.appendChild(el);
  }

  // wire actions
  cards.querySelectorAll('[data-open]').forEach(b=>{
    b.addEventListener('click', ()=>openEntry(b.getAttribute('data-open')));
  });
  cards.querySelectorAll('[data-cite]').forEach(b=>{
    b.addEventListener('click', ()=>copyText(`OMPC-1 • ${b.getAttribute('data-cite')} • ${REPO}`));
  });
  cards.querySelectorAll('[data-lens]').forEach(b=>{
    b.addEventListener('click', ()=>{
      tabs[1].click();
      // simple: you can later expand this into real mismatch timelines
    });
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

async function openEntry(path){
  if(!path || path==='#') return;
  try{
    const r = await fetch(path, { cache:'no-store' });
    const md = await r.text();
    // ultra-simple modal (no external libs)
    const modal = document.createElement('div');
    modal.style.position='fixed';
    modal.style.inset='0';
    modal.style.zIndex='99';
    modal.style.background='rgba(0,0,0,.72)';
    modal.style.backdropFilter='blur(10px)';
    modal.style.padding='14px';
    modal.innerHTML = `
      <div style="max-width:980px;margin:0 auto;border:1px solid rgba(255,255,255,.10);border-radius:18px;background:rgba(10,12,16,.88);box-shadow:0 18px 70px rgba(0,0,0,.6);overflow:hidden;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.08);">
          <div style="font-weight:800;letter-spacing:.3px;color:rgba(215,181,109,.95)">ENTRY VIEW</div>
          <button id="x" style="border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.35);color:white;padding:8px 10px;border-radius:12px;font-weight:800;cursor:pointer;">CLOSE</button>
        </div>
        <pre style="margin:0;padding:12px;white-space:pre-wrap;word-wrap:break-word;color:rgba(255,255,255,.86);font-size:12px;line-height:1.5;">${escapeHtml(md)}</pre>
      </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#x').onclick = ()=>modal.remove();
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.remove(); });
  } catch(e){}
}

async function loadAll(){
  $('#regState').textContent = 'Loading…';
  $('#regState').style.color = 'rgba(215,181,109,.95)';
  $('#updated').textContent = 'Updated: —';

  // prefer registry/index.json if present; otherwise auto-index from /entries
  const fromRegistry = await tryLoadRegistryIndex();
  if(fromRegistry){
    ALL = fromRegistry;
    $('#regState').textContent = 'Live (registry/index.json)';
    $('#regState').style.color = 'rgba(52,211,153,.95)';
    $('#regPath').textContent = PATHS.registry;
    render(ALL);
    return;
  }

  // auto-index
  const files = await listEntryFiles();
  ALL = normalizeFromFiles(files);

  $('#regState').textContent = 'Live (auto-index)';
  $('#regState').style.color = 'rgba(52,211,153,.95)';
  $('#regPath').textContent = '/entries/*.md';
  $('#updated').textContent = 'Updated: ' + new Date().toISOString().slice(0,10);

  render(ALL);
}

$('#q').addEventListener('input', ()=>render(ALL));
$('#status').addEventListener('change', ()=>render(ALL));
$('#btnRefresh').addEventListener('click', ()=>loadAll());

loadAll().catch(()=>{
  $('#regState').textContent = 'Offline';
  $('#regState').style.color = 'rgba(251,113,133,.95)';
});
</script>
</body>
</html>
